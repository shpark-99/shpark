<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>위치 인증 시스템</title>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a50e768349b68eac92037c8858d7a462&libraries=services,geometry"></script>
<style>
    #map { width: 100%; height: 400px; margin-bottom: 10px; }
    #statusMessage { font-size: 16px; font-weight: bold; }
    button:disabled { background-color: gray; cursor: not-allowed; }
</style>
</head>
<body>
<h2>📍 위치 인증 시스템</h2>
<div>
    <input type="text" id="addressInput" placeholder="기준 위치 주소 입력">
    <button onclick="setBaseLocation()">📍 기준 위치 설정</button>
</div>
<br>
<button id="verifyButton" onclick="verifyMyLocation()" disabled>내 위치 인증</button>
<p id="statusMessage">⏳ 위치 인증 대기 중...</p>
<div id="map"></div>

<script>
let map, geocoder, baseMarker, userMarker, circle, targetLocation = null;

function initMap() {
    console.log("✅ initMap() 실행 중...");
    const container = document.getElementById('map');
    map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5 });
    geocoder = new kakao.maps.services.Geocoder();
    console.log("✅ 카카오 지도 초기화 완료!");
}

function setBaseLocation() {
    const address = document.getElementById("addressInput").value.trim();
    if (!address) {
        alert("주소를 입력하세요!");
        return;
    }

    geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            const lat = result[0].y, lng = result[0].x;
            targetLocation = new kakao.maps.LatLng(lat, lng);

            // 기존 마커 및 원 삭제 후 새로 생성
            if (baseMarker) baseMarker.setMap(null);
            baseMarker = new kakao.maps.Marker({ map: map, position: targetLocation, title: "기준 위치" });

            if (circle) circle.setMap(null);
            circle = new kakao.maps.Circle({
                map: map, center: targetLocation, radius: 300,
                strokeWeight: 2, strokeColor: '#FF0000', strokeOpacity: 0.8,
                fillColor: '#FF0000', fillOpacity: 0.2
            });

            map.setCenter(targetLocation);
            document.getElementById("verifyButton").disabled = false; // 인증 버튼 활성화
            updateStatusMessage("✅ 기준 위치 설정 완료! 위치 인증 가능.", "blue");
        } else {
            alert("❌ 주소 검색 실패! 올바른 주소를 입력하세요.");
        }
    });
}

function verifyMyLocation() {
    if (!targetLocation) {
        alert("❌ 기준 위치를 먼저 설정하세요!");
        return;
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude, userLng = position.coords.longitude;
                const userLocation = new kakao.maps.LatLng(userLat, userLng);

                if (userMarker) userMarker.setMap(null);
                userMarker = new kakao.maps.Marker({
                    map: map, position: userLocation, title: "내 위치",
                    image: new kakao.maps.MarkerImage(
                        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
                        new kakao.maps.Size(40, 40), { offset: new kakao.maps.Point(20, 40) }
                    )
                });

                checkDistance(userLocation);
            },
            function(error) {
                alert("❌ 위치 정보를 가져올 수 없습니다! (에러 코드: " + error.code + ")");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
        );
    } else {
        alert("❌ 이 브라우저에서는 위치 정보를 지원하지 않습니다!");
    }
}

function checkDistance(userLocation) {
    if (!kakao.maps.geometry) {
        alert("❌ kakao.maps.geometry가 로드되지 않았습니다. 라이브러리 설정을 확인하세요.");
        return;
    }

    const distance = kakao.maps.geometry.computeDistanceBetween(targetLocation, userLocation);
    console.log(`📏 거리: ${distance.toFixed(2)}m`);
    const statusMessage = document.getElementById("statusMessage");

    if (distance <= 300) {
        updateStatusMessage("✅ 위치 인증 성공! 반경 300m 이내입니다.", "green");
        document.getElementById("verifyButton").disabled = true; // 인증 버튼 비활성화
    } else {
        updateStatusMessage("❌ 위치 인증 실패! 반경을 벗어났습니다.", "red");
    }
}

function updateStatusMessage(message, color) {
    const statusMessage = document.getElementById("statusMessage");
    statusMessage.innerText = message;
    statusMessage.style.color = color;
}

window.onload = initMap;
</script>
</body>
</html>

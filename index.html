<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ì¹˜ ì¸ì¦ ì‹œìŠ¤í…œ</title>
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
    <h2>ğŸ“ ìœ„ì¹˜ ì¸ì¦ ì‹œìŠ¤í…œ</h2>
    <button onclick="setBaseLocation()">ğŸ“ ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì •</button>
    <button onclick="verifyMyLocation()">ë‚´ ìœ„ì¹˜ ì¸ì¦</button>
    <div id="map"></div>

    <script>
        let map;
        let baseMarker;
        let userMarker;
        let basePosition;

        function loadKakaoMapsAPI() {
            return new Promise((resolve, reject) => {
                if (window.kakao && window.kakao.maps) {
                    console.log("âœ… Kakao Maps API ì´ë¯¸ ë¡œë“œë¨");
                    resolve();
                    return;
                }

                const script = document.createElement("script");
                script.src = "https://dapi.kakao.com/v2/maps/sdk.js?appkey=a50e768349b68eac92037c8858d7a462&libraries=services,geometry";
                script.async = true;
                script.onload = () => {
                    console.log("âœ… Kakao Maps API ë¡œë“œ ì™„ë£Œ");
                    resolve();
                };
                script.onerror = () => reject(new Error("âŒ Kakao Maps API ë¡œë“œ ì‹¤íŒ¨"));
                document.head.appendChild(script);
            });
        }

        async function initMap() {
            try {
                await loadKakaoMapsAPI();

                if (!window.kakao || !window.kakao.maps) {
                    throw new Error("âŒ Kakao Maps APIê°€ ì •ìƒì ìœ¼ë¡œ ë¡œë“œë˜ì§€ ì•ŠìŒ");
                }

                console.log("âœ… initMap ì‹¤í–‰ë¨");

                const container = document.getElementById("map");
                const options = {
                    center: new kakao.maps.LatLng(37.5665, 126.978), // ê¸°ë³¸ ìœ„ì¹˜ (ì„œìš¸)
                    level: 3,
                };

                map = new kakao.maps.Map(container, options);
                console.log("âœ… ì§€ë„ ìƒì„± ì™„ë£Œ");

            } catch (error) {
                console.error(error);
                alert("ì§€ë„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ!");
            }
        }

        function setBaseLocation() {
            if (!map) {
                alert("âŒ ì§€ë„ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");
                return;
            }

            basePosition = map.getCenter(); // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ì„ ê¸°ì¤€ ìœ„ì¹˜ë¡œ ì„¤ì •

            if (baseMarker) baseMarker.setMap(null);

            baseMarker = new kakao.maps.Marker({
                position: basePosition,
                map: map,
            });

            console.log("âœ… ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ:", basePosition);
            alert(`ğŸ“ ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ!`);
        }

        function verifyMyLocation() {
            if (!navigator.geolocation) {
                alert("âŒ í˜„ì¬ ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            if (!basePosition) {
                alert("ğŸ“ ë¨¼ì € ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const userPosition = new kakao.maps.LatLng(userLat, userLng);

                    if (userMarker) userMarker.setMap(null);

                    userMarker = new kakao.maps.Marker({
                        position: userPosition,
                        map: map,
                    });

                    map.setCenter(userPosition); // ì‚¬ìš©ìì˜ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™

                    console.log("âœ… í˜„ì¬ ìœ„ì¹˜:", userLat, userLng);
                    checkDistance(userLat, userLng, basePosition.getLat(), basePosition.getLng());
                },
                (error) => {
                    console.error("âŒ ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                    alert("âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            );
        }

        function checkDistance(userLat, userLng, targetLat, targetLng) {
            if (!kakao.maps || !kakao.maps.geometry) {
                alert("âŒ kakao.maps.geometry ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }

            const userPosition = new kakao.maps.LatLng(userLat, userLng);
            const targetPosition = new kakao.maps.LatLng(targetLat, targetLng);
            const distance = kakao.maps.geometry.computeDistanceBetween(userPosition, targetPosition);

            console.log(`ğŸ“ ê±°ë¦¬ ê³„ì‚° ê²°ê³¼: ${distance}m`);

            if (distance <= 300) {
                alert("âœ… ì¸ì¦ ì™„ë£Œ: 300m ì´ë‚´");
            } else {
                alert("âŒ ì¸ì¦ ì‹¤íŒ¨: 300m ì´ˆê³¼");
            }
        }

        // í˜ì´ì§€ ë¡œë“œ í›„ ì§€ë„ ì´ˆê¸°í™”
        initMap();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ìœ„ì¹˜ ì¸ì¦ ì‹œìŠ¤í…œ</title>
<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=a50e768349b68eac92037c8858d7a462&libraries=services,geometry"></script>
<style>
    #map { width: 100%; height: 400px; margin-bottom: 10px; }
    #statusMessage { font-size: 16px; font-weight: bold; }
    button:disabled { background-color: gray; cursor: not-allowed; }
</style>
</head>
<body>
<h2>ğŸ“ ìœ„ì¹˜ ì¸ì¦ ì‹œìŠ¤í…œ</h2>
<div>
    <input type="text" id="addressInput" placeholder="ê¸°ì¤€ ìœ„ì¹˜ ì£¼ì†Œ ì…ë ¥">
    <button onclick="setBaseLocation()">ğŸ“ ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì •</button>
</div>
<br>
<button id="verifyButton" onclick="verifyMyLocation()" disabled>ë‚´ ìœ„ì¹˜ ì¸ì¦</button>
<p id="statusMessage">â³ ìœ„ì¹˜ ì¸ì¦ ëŒ€ê¸° ì¤‘...</p>
<div id="map"></div>

<script>
let map, geocoder, baseMarker, userMarker, circle, targetLocation = null;

function initMap() {
    console.log("âœ… initMap() ì‹¤í–‰ ì¤‘...");
    const container = document.getElementById('map');
    map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 5 });
    geocoder = new kakao.maps.services.Geocoder();
    console.log("âœ… ì¹´ì¹´ì˜¤ ì§€ë„ ì´ˆê¸°í™” ì™„ë£Œ!");
}

function setBaseLocation() {
    const address = document.getElementById("addressInput").value.trim();
    if (!address) {
        alert("ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        return;
    }

    geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            const lat = result[0].y, lng = result[0].x;
            targetLocation = new kakao.maps.LatLng(lat, lng);

            // ê¸°ì¡´ ë§ˆì»¤ ë° ì› ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„±
            if (baseMarker) baseMarker.setMap(null);
            baseMarker = new kakao.maps.Marker({ map: map, position: targetLocation, title: "ê¸°ì¤€ ìœ„ì¹˜" });

            if (circle) circle.setMap(null);
            circle = new kakao.maps.Circle({
                map: map, center: targetLocation, radius: 300,
                strokeWeight: 2, strokeColor: '#FF0000', strokeOpacity: 0.8,
                fillColor: '#FF0000', fillOpacity: 0.2
            });

            map.setCenter(targetLocation);
            document.getElementById("verifyButton").disabled = false; // ì¸ì¦ ë²„íŠ¼ í™œì„±í™”
            updateStatusMessage("âœ… ê¸°ì¤€ ìœ„ì¹˜ ì„¤ì • ì™„ë£Œ! ìœ„ì¹˜ ì¸ì¦ ê°€ëŠ¥.", "blue");
        } else {
            alert("âŒ ì£¼ì†Œ ê²€ìƒ‰ ì‹¤íŒ¨! ì˜¬ë°”ë¥¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        }
    });
}

function verifyMyLocation() {
    if (!targetLocation) {
        alert("âŒ ê¸°ì¤€ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„¤ì •í•˜ì„¸ìš”!");
        return;
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const userLat = position.coords.latitude, userLng = position.coords.longitude;
                const userLocation = new kakao.maps.LatLng(userLat, userLng);

                if (userMarker) userMarker.setMap(null);
                userMarker = new kakao.maps.Marker({
                    map: map, position: userLocation, title: "ë‚´ ìœ„ì¹˜",
                    image: new kakao.maps.MarkerImage(
                        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
                        new kakao.maps.Size(40, 40), { offset: new kakao.maps.Point(20, 40) }
                    )
                });

                checkDistance(userLocation);
            },
            function(error) {
                alert("âŒ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤! (ì—ëŸ¬ ì½”ë“œ: " + error.code + ")");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 30000 }
        );
    } else {
        alert("âŒ ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!");
    }
}

function checkDistance(userLocation) {
    if (!kakao.maps.geometry) {
        alert("âŒ kakao.maps.geometryê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
        return;
    }

    const distance = kakao.maps.geometry.computeDistanceBetween(targetLocation, userLocation);
    console.log(`ğŸ“ ê±°ë¦¬: ${distance.toFixed(2)}m`);
    const statusMessage = document.getElementById("statusMessage");

    if (distance <= 300) {
        updateStatusMessage("âœ… ìœ„ì¹˜ ì¸ì¦ ì„±ê³µ! ë°˜ê²½ 300m ì´ë‚´ì…ë‹ˆë‹¤.", "green");
        document.getElementById("verifyButton").disabled = true; // ì¸ì¦ ë²„íŠ¼ ë¹„í™œì„±í™”
    } else {
        updateStatusMessage("âŒ ìœ„ì¹˜ ì¸ì¦ ì‹¤íŒ¨! ë°˜ê²½ì„ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.", "red");
    }
}

function updateStatusMessage(message, color) {
    const statusMessage = document.getElementById("statusMessage");
    statusMessage.innerText = message;
    statusMessage.style.color = color;
}

window.onload = initMap;
</script>
</body>
</html>
